version: '3.8'

services:
  # Contenedor de trabajo con herramientas de pentesting
  attacker:
    image: kalilinux/kali-rolling
    container_name: workshop_attacker
    hostname: attacker
    volumes:
      - ./exercises:/exercises
      - ./wordlists:/wordlists
      - ./scripts:/scripts
      - ./solutions:/solutions
      - ./custom_wordlists:/custom_wordlists
    command: >
      /bin/bash -c " apt update && apt install -y john hashcat hydra git python3 python3-pip curl wget vim nano tree ffuf jq proxychains4 && git clone https://github.com/Mebus/cupp.git /opt/cupp && git clone https://github.com/LandGrey/pydictor.git /opt/pydictor && git clone https://github.com/pcaro90/palabrario.git /opt/palabrario && git clone --depth 1 https://github.com/danielmiessler/SecLists.git /opt/SecLists && pip3 install requests[socks] requests-ip-rotator beautifulsoup4 lxml colorama name-that-hash --break-system-packages && mkdir -p /opt/rules && wget https://raw.githubusercontent.com/NotSoSecure/password_cracking_rules/master/OneRuleToRuleThemAll.rule -O /opt/rules/OneRuleToRuleThemAll.rule && wget https://raw.githubusercontent.com/praetorian-inc/Hob0Rules/master/hob064.rule -O /opt/rules/hob064.rule && ln -sf /opt/SecLists/Passwords /wordlists/seclists && echo 'Entorno listo. Herramientas: FFUF, NTH, Pydictor, SecLists, Rules, Palabrario, JQ' && echo 'Usa: docker-compose exec attacker /bin/bash' && tail -f /dev/null "
    networks:
      - lab-network
    stdin_open: true
    tty: true

  # Objetivo SSH con credenciales débiles
  ssh-target:
    image: linuxserver/openssh-server:latest
    container_name: workshop_ssh
    hostname: ssh-target
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Europe/Madrid
      - PASSWORD_ACCESS=true
      - USER_NAME=testuser
      - USER_PASSWORD=password123
    volumes:
      - ./exercises/module5/ssh-data:/config
    ports:
      - "2222:2222"
    networks:
      - lab-network

  # Módulo 8b: SSH con Fail2Ban (Práctica de Defensa)
  ssh-protected:
    build: ./exercises/module8b/ssh-protected
    container_name: workshop_ssh_protected
    hostname: ssh-protected
    ports:
      - "2223:22"
    cap_add:
      - NET_ADMIN # Necesario para iptables
    networks:
      - lab-network

  # DVWA para ataques web
  dvwa:
    # Nota: ghcr.io/digininja/dvwa es multi-arch (x86 + ARM)
    image: ghcr.io/digininja/dvwa:latest
    container_name: workshop_dvwa
    hostname: dvwa
    environment:
      - MYSQL_HOST=dvwa-db
      - MYSQL_DATABASE=dvwa
      - MYSQL_USER=dvwa
      - MYSQL_PASSWORD=dvwa
    ports:
      - "8080:80"
    depends_on:
      - dvwa-db
    networks:
      - lab-network

  # Base de datos para DVWA
  dvwa-db:
    image: mariadb:10.11
    container_name: workshop_dvwa_db
    hostname: dvwa-db
    environment:
      - MYSQL_ROOT_PASSWORD=rootpass
      - MYSQL_DATABASE=dvwa
      - MYSQL_USER=dvwa
      - MYSQL_PASSWORD=dvwa
    volumes:
      - dvwa-data:/var/lib/mysql
    networks:
      - lab-network

  # API vulnerable para credential stuffing
  vulnerable-api:
    build: ./vulnerable-api
    container_name: workshop_api
    hostname: vulnerable-api
    ports:
      - "5000:5000"
    networks:
      - lab-network
    environment:
      - FLASK_ENV=development
      - PYTHONUNBUFFERED=1
    volumes:
      - ./vulnerable-api:/app

  # Proxy Tor para rotación de IPs (Módulo 9)
  # Nota: peterdavehello/tor-socks-proxy es multi-arch (x86 + ARM)
  tor-proxy:
    image: peterdavehello/tor-socks-proxy:latest
    container_name: workshop_tor
    hostname: tor-proxy
    ports:
      - "9050:9050" # SOCKS5 proxy (sin 8118, usa 9050 directamente)
    networks:
      - lab-network

  # Módulo 10: Target App (Víctima)
  target-app:
    build: ./exercises/module10/target-app
    container_name: workshop_target_2fa
    hostname: target-app
    networks:
      - lab-network
    # Exponemos puerto para simular el "Sitio Real" y probar el secuestro de sesión
    ports:
      - "8088:443"

  # Módulo 10: Modlishka (Atacante)
  # Requiere mapear '127.0.0.1 phishing.local' en /etc/hosts del host
  modlishka:
    build: ./exercises/module10/modlishka-docker
    container_name: workshop_modlishka
    hostname: phishing.local
    ports:
      - "443:443"
      - "80:80"
      - "10000:10000" # Control panel (opcional)
    volumes:
      - ./exercises/module10/modlishka-config/config.json:/etc/modlishka/config.json
    # Command para ejecutar modlishka con la config
    command: /app/modlishka -config /etc/modlishka/config.json
    networks:
      - lab-network

networks:
  lab-network:
    driver: bridge
    name: workshop_network

volumes:
  dvwa-data:


